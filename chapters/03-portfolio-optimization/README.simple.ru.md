# Глава 3: Как правильно раскладывать яйца по корзинам

## Для кого эта глава?

Эта глава написана простым языком — как будто я объясняю своему младшему брату или сестре. Если ты школьник или просто хочешь понять основы без сложной математики — добро пожаловать!

---

## Главная идея: Не клади все яйца в одну корзину!

Представь, что бабушка дала тебе 10 яиц и попросила донести их до дома. У тебя есть три корзинки разного размера.

**Вариант 1**: Положить все 10 яиц в одну большую корзину.
- Если ты споткнёшься и уронишь эту корзину — разобьются ВСЕ яйца!

**Вариант 2**: Разложить яйца по трём корзинам.
- Если уронишь одну — потеряешь только часть яиц, остальные целы!

**Это и есть главный принцип инвестирования — диверсификация!**

---

## История: Умный дедушка Марковиц

В 1952 году жил-был учёный по имени Гарри Марковиц. Он задумался: "А как правильно раскладывать деньги по разным инвестициям?"

Он придумал простое правило:
> **Нужно смотреть не только на то, сколько можно заработать, но и на то, сколько можно потерять!**

За эту идею ему дали Нобелевскую премию в 1990 году.

---

## Пример из жизни: Киоск с мороженым и зонтиками

Представь, что у тебя есть немного денег и ты хочешь открыть бизнес. У тебя два варианта:

### Бизнес 1: Киоск с мороженым
- В солнечную погоду: зарабатываешь **1000 рублей** в день
- В дождь: зарабатываешь **0 рублей** (никто не хочет мороженое)

### Бизнес 2: Киоск с зонтиками
- В солнечную погоду: зарабатываешь **0 рублей** (никому не нужны зонтики)
- В дождь: зарабатываешь **1000 рублей**

### Что выбрать?

**Вариант А**: Вложить все деньги в мороженое
- Если будет солнце — заработаешь много!
- Если будет дождь — ничего не заработаешь :(

**Вариант Б**: Вложить все деньги в зонтики
- Если будет дождь — заработаешь много!
- Если будет солнце — ничего не заработаешь :(

**Вариант В**: Вложить половину в мороженое, половину в зонтики
- Если будет солнце: 500 рублей от мороженого + 0 от зонтиков = **500 рублей**
- Если будет дождь: 0 от мороженого + 500 от зонтиков = **500 рублей**

**Магия!** В варианте В ты **ВСЕГДА** зарабатываешь 500 рублей, независимо от погоды!

Это называется **хеджирование** — когда одна инвестиция защищает другую.

---

## Что такое риск? (Простое объяснение)

**Риск** — это насколько сильно может измениться твой результат.

### Пример: Два способа добраться до школы

**Способ 1: Пешком**
- Всегда идёшь 20 минут
- Иногда 19, иногда 21 — но почти всегда около 20
- **Риск низкий** — результат предсказуемый

**Способ 2: На автобусе**
- Иногда 10 минут (если повезёт с пробками)
- Иногда 40 минут (если застрянешь в пробке)
- В среднем тоже около 20 минут
- **Риск высокий** — результат непредсказуемый

Оба способа в среднем занимают 20 минут, но **автобус рискованнее**, потому что результат может сильно отличаться!

---

## Корреляция: Когда дела идут вместе

**Корреляция** показывает, как связаны между собой разные вещи.

### Положительная корреляция (движутся вместе)
- Температура на улице и продажи мороженого
- Когда жарко → покупают больше мороженого
- Когда холодно → покупают меньше мороженого

### Отрицательная корреляция (движутся в противоположные стороны)
- Мороженое и зонтики (как в нашем примере)
- Когда солнце → мороженое хорошо, зонтики плохо
- Когда дождь → мороженое плохо, зонтики хорошо

### Нет корреляции (никак не связаны)
- Продажи мороженого в Москве и продажи рыбы в Токио
- Они никак не влияют друг на друга

**Главный секрет диверсификации:**
> Чтобы диверсификация работала, нужно выбирать активы с **низкой или отрицательной корреляцией**!

Если положить деньги в два бизнеса, которые падают вместе — это НЕ диверсификация!

---

## Risk Parity: Все делят риск поровну

Представь, что в твоём классе 4 ученика делают групповой проект:
- Маша — отличница, очень надёжная
- Петя — хорошист, довольно надёжный
- Вася — троечник, не очень надёжный
- Катя — двоечница, совсем ненадёжная

### Обычный подход: Каждому дать по 25% работы
Проблема: Катя провалит свою часть и потянет всех вниз!

### Risk Parity подход: Распределить по надёжности
- Маша делает 40% работы (она надёжная, можно доверить много)
- Петя делает 30%
- Вася делает 20%
- Катя делает 10% (меньше работы — меньше риска)

Теперь если Катя провалится, это повлияет только на 10% проекта, а не на 25%!

**Risk Parity в инвестициях:**
> Надёжным активам (облигации) даём МЕНЬШЕ денег, рискованным (акции) — БОЛЬШЕ, чтобы вклад в общий риск был одинаковым.

Подожди... это кажется неправильным? На самом деле всё наоборот:
- Облигации менее волатильны → чтобы они "чувствовались" так же, как акции, им нужно больше веса
- Акции более волатильны → даже маленькая доля создаёт много риска

---

## VaR: Худший день (почти)

**VaR (Value at Risk)** — это способ сказать: "В 95% случаев я потеряю не больше, чем X рублей".

### Пример: Американские горки

Представь, что ты катаешься на американских горках 100 раз. Каждый раз ты записываешь, насколько страшно было по шкале от 0 до 10.

Результаты (от наименее страшного к самому страшному):
- 95 заездов: страх от 0 до 7
- 5 заездов: страх от 8 до 10 (очень страшно!)

**VaR с уровнем 95%** = 7

Это значит: "В 95% случаев мой страх не превысит 7 из 10".

### В инвестициях

Если у тебя 100,000 рублей и **VaR 95% = 5,000 рублей**, это значит:
> "В 95 днях из 100 я потеряю не больше 5,000 рублей"

Но в 5 днях из 100 потери могут быть БОЛЬШЕ 5,000!

---

## Maximum Drawdown: Самое глубокое падение

**Drawdown (просадка)** — насколько сильно упало от максимума.

### Пример: Подъём в гору

Представь, что ты поднимаешься в гору:
1. Стартуешь на высоте 0 метров
2. Поднимаешься до 100 метров (ура, новый рекорд!)
3. Спускаешься в ямку на 80 метров (просадка 20 метров)
4. Поднимаешься до 150 метров (новый рекорд!)
5. Спускаешься до 90 метров (просадка 60 метров)
6. Поднимаешься до 200 метров

**Maximum Drawdown = 60 метров** — это самое глубокое падение от вершины.

### В инвестициях

Если твой портфель:
1. Вырос до 150,000 рублей
2. Упал до 90,000 рублей
3. Снова вырос до 200,000 рублей

Maximum Drawdown = 150,000 - 90,000 = **60,000 рублей** (или 40%)

Это важно! Даже если в конце ты заработал — в процессе тебе было очень плохо, когда потерял 40%.

---

## Почему простое "поровну" не работает?

### Пример: Распределение еды для пикника

Ты организуешь пикник и берёшь:
- 1 арбуз (10 кг)
- 1 пакет чипсов (100 г)
- 1 бутылку воды (1 л)

Если сказать "берём по одной штуке каждого" — вроде поровну? Но арбуз весит в 100 раз больше чипсов!

В инвестициях то же самое:
- Акции очень волатильны (как тяжёлый арбуз)
- Облигации стабильны (как лёгкие чипсы)

Если вложить 50% в акции и 50% в облигации, то:
- Акции будут определять 90% движений твоего портфеля!
- Облигации почти не повлияют

**Risk Parity** решает эту проблему, измеряя "вес" по риску, а не по деньгам.

---

## Код на Rust: Простой калькулятор портфеля

```rust
/// Простой портфель из двух активов
fn main() {
    // Актив 1: Агрессивные акции
    // Средняя доходность 15% в год, но волатильность 30%
    let stock_return = 0.15;
    let stock_volatility = 0.30;

    // Актив 2: Облигации
    // Средняя доходность 5% в год, волатильность 5%
    let bond_return = 0.05;
    let bond_volatility = 0.05;

    // Корреляция между ними (слабая положительная)
    let correlation = 0.2;

    println!("=== Сравнение разных стратегий ===\n");

    // Стратегия 1: Всё в акции
    println!("Стратегия 1: 100% акции");
    println!("  Ожидаемая доходность: {:.1}%", stock_return * 100.0);
    println!("  Волатильность: {:.1}%", stock_volatility * 100.0);
    println!();

    // Стратегия 2: Всё в облигации
    println!("Стратегия 2: 100% облигации");
    println!("  Ожидаемая доходность: {:.1}%", bond_return * 100.0);
    println!("  Волатильность: {:.1}%", bond_volatility * 100.0);
    println!();

    // Стратегия 3: 50/50
    let weight_stocks = 0.5;
    let weight_bonds = 0.5;

    let portfolio_return = weight_stocks * stock_return + weight_bonds * bond_return;

    // Формула для волатильности портфеля из двух активов:
    // σ_p = √(w1²·σ1² + w2²·σ2² + 2·w1·w2·σ1·σ2·ρ)
    let portfolio_volatility = (
        (weight_stocks * stock_volatility).powi(2)
        + (weight_bonds * bond_volatility).powi(2)
        + 2.0 * weight_stocks * weight_bonds * stock_volatility * bond_volatility * correlation
    ).sqrt();

    println!("Стратегия 3: 50% акции + 50% облигации");
    println!("  Ожидаемая доходность: {:.1}%", portfolio_return * 100.0);
    println!("  Волатильность: {:.1}%", portfolio_volatility * 100.0);
    println!();

    // Стратегия 4: Risk Parity (упрощённо)
    // Идея: дать больше веса менее волатильному активу
    // Вес обратно пропорционален волатильности
    let inv_vol_stocks = 1.0 / stock_volatility;
    let inv_vol_bonds = 1.0 / bond_volatility;
    let total_inv_vol = inv_vol_stocks + inv_vol_bonds;

    let rp_weight_stocks = inv_vol_stocks / total_inv_vol;
    let rp_weight_bonds = inv_vol_bonds / total_inv_vol;

    let rp_return = rp_weight_stocks * stock_return + rp_weight_bonds * bond_return;

    let rp_volatility = (
        (rp_weight_stocks * stock_volatility).powi(2)
        + (rp_weight_bonds * bond_volatility).powi(2)
        + 2.0 * rp_weight_stocks * rp_weight_bonds * stock_volatility * bond_volatility * correlation
    ).sqrt();

    println!("Стратегия 4: Risk Parity");
    println!("  Веса: {:.1}% акции + {:.1}% облигации",
        rp_weight_stocks * 100.0, rp_weight_bonds * 100.0);
    println!("  Ожидаемая доходность: {:.1}%", rp_return * 100.0);
    println!("  Волатильность: {:.1}%", rp_volatility * 100.0);
    println!();

    // Коэффициент Шарпа (доходность на единицу риска)
    let risk_free = 0.03; // Безрисковая ставка 3%

    println!("=== Коэффициент Шарпа (чем больше - тем лучше) ===");
    println!("  100% акции: {:.2}", (stock_return - risk_free) / stock_volatility);
    println!("  100% облигации: {:.2}", (bond_return - risk_free) / bond_volatility);
    println!("  50/50: {:.2}", (portfolio_return - risk_free) / portfolio_volatility);
    println!("  Risk Parity: {:.2}", (rp_return - risk_free) / rp_volatility);
}
```

**Результат:**
```
=== Сравнение разных стратегий ===

Стратегия 1: 100% акции
  Ожидаемая доходность: 15.0%
  Волатильность: 30.0%

Стратегия 2: 100% облигации
  Ожидаемая доходность: 5.0%
  Волатильность: 5.0%

Стратегия 3: 50% акции + 50% облигации
  Ожидаемая доходность: 10.0%
  Волатильность: 15.8%

Стратегия 4: Risk Parity
  Веса: 14.3% акции + 85.7% облигации
  Ожидаемая доходность: 6.4%
  Волатильность: 5.8%

=== Коэффициент Шарпа (чем больше - тем лучше) ===
  100% акции: 0.40
  100% облигации: 0.40
  50/50: 0.44
  Risk Parity: 0.59
```

Видишь? Risk Parity даёт лучший коэффициент Шарпа!

---

## Простой расчёт VaR на Rust

```rust
/// Вычисляем VaR методом "исторического моделирования"
fn calculate_var(returns: &[f64], confidence: f64) -> f64 {
    // Сортируем доходности от худшей к лучшей
    let mut sorted = returns.to_vec();
    sorted.sort_by(|a, b| a.partial_cmp(b).unwrap());

    // Находим значение на уровне (1 - confidence)
    // Например, для 95% уверенности берём 5-й процентиль
    let index = ((1.0 - confidence) * sorted.len() as f64).floor() as usize;

    // VaR — это потенциальный убыток (со знаком минус)
    -sorted[index]
}

fn main() {
    // Представим, что у нас есть история дневных доходностей за 100 дней
    // В процентах: -5%, +2%, -1%, +3%, ... и т.д.
    let daily_returns = vec![
        -0.05, 0.02, -0.01, 0.03, -0.02, 0.01, -0.03, 0.04, -0.01, 0.02,
        -0.04, 0.03, -0.02, 0.01, -0.01, 0.02, -0.03, 0.05, -0.02, 0.01,
        -0.01, 0.02, -0.02, 0.03, -0.01, 0.01, -0.04, 0.02, -0.01, 0.03,
        -0.02, 0.01, -0.01, 0.02, -0.03, 0.04, -0.02, 0.01, -0.05, 0.03,
        -0.01, 0.02, -0.02, 0.01, -0.01, 0.03, -0.02, 0.02, -0.01, 0.01,
        -0.03, 0.02, -0.01, 0.04, -0.02, 0.01, -0.02, 0.03, -0.01, 0.02,
        -0.01, 0.01, -0.04, 0.02, -0.02, 0.03, -0.01, 0.02, -0.03, 0.01,
        -0.02, 0.03, -0.01, 0.01, -0.02, 0.02, -0.01, 0.04, -0.03, 0.02,
        -0.01, 0.01, -0.02, 0.03, -0.01, 0.02, -0.04, 0.01, -0.02, 0.03,
        -0.01, 0.02, -0.02, 0.01, -0.01, 0.03, -0.02, 0.02, -0.06, 0.01,
    ];

    let var_95 = calculate_var(&daily_returns, 0.95);
    let var_99 = calculate_var(&daily_returns, 0.99);

    println!("Анализ риска портфеля:");
    println!();
    println!("VaR 95%: {:.2}%", var_95 * 100.0);
    println!("  Это значит: в 95 днях из 100 потери не превысят {:.2}%", var_95 * 100.0);
    println!();
    println!("VaR 99%: {:.2}%", var_99 * 100.0);
    println!("  Это значит: в 99 днях из 100 потери не превысят {:.2}%", var_99 * 100.0);

    // Если у нас портфель на 1,000,000 рублей:
    let portfolio_value = 1_000_000.0;
    println!();
    println!("Для портфеля в {:,.0} рублей:", portfolio_value);
    println!("  VaR 95% = {:,.0} рублей", var_95 * portfolio_value);
    println!("  VaR 99% = {:,.0} рублей", var_99 * portfolio_value);
}
```

---

## Maximum Drawdown на Rust

```rust
/// Вычисляем максимальную просадку
fn maximum_drawdown(prices: &[f64]) -> (f64, usize, usize) {
    let mut max_dd = 0.0;
    let mut peak_day = 0;
    let mut bottom_day = 0;

    let mut running_max = prices[0];
    let mut running_max_day = 0;

    for (day, &price) in prices.iter().enumerate() {
        // Новый максимум?
        if price > running_max {
            running_max = price;
            running_max_day = day;
        }

        // Текущая просадка
        let drawdown = (running_max - price) / running_max;

        // Новый рекорд просадки?
        if drawdown > max_dd {
            max_dd = drawdown;
            peak_day = running_max_day;
            bottom_day = day;
        }
    }

    (max_dd, peak_day, bottom_day)
}

fn main() {
    // История цены портфеля по дням
    let portfolio_prices = vec![
        100.0, 102.0, 105.0, 103.0, 108.0, 110.0, 107.0, 105.0,
        102.0, 98.0, 95.0, 97.0, 100.0, 105.0, 110.0, 115.0,
        112.0, 108.0, 105.0, 110.0, 118.0, 125.0, 122.0, 128.0,
    ];

    let (max_dd, peak, bottom) = maximum_drawdown(&portfolio_prices);

    println!("=== Анализ Maximum Drawdown ===");
    println!();
    println!("Максимальная просадка: {:.1}%", max_dd * 100.0);
    println!("Пик был на день: {} (цена: {:.0})", peak + 1, portfolio_prices[peak]);
    println!("Дно было на день: {} (цена: {:.0})", bottom + 1, portfolio_prices[bottom]);
    println!();
    println!("Это значит: в какой-то момент портфель упал на {:.1}% от максимума", max_dd * 100.0);

    // Визуализация
    println!();
    println!("График цены (упрощённо):");
    let max_price = portfolio_prices.iter().cloned().fold(f64::NEG_INFINITY, f64::max);
    for (day, &price) in portfolio_prices.iter().enumerate() {
        let bar_length = (price / max_price * 40.0) as usize;
        let bar: String = "█".repeat(bar_length);
        let marker = if day == peak {
            " <-- ПИК"
        } else if day == bottom {
            " <-- ДНО"
        } else {
            ""
        };
        println!("День {:2}: {} {:.0}{}", day + 1, bar, price, marker);
    }
}
```

---

## Главные выводы (запомни это!)

### 1. Диверсификация — твой друг
Не вкладывай все деньги в одно место. Раскладывай по разным активам.

### 2. Смотри не только на доходность
Высокая доходность часто означает высокий риск. Ищи баланс!

### 3. Корреляция важна
Выбирай активы, которые не движутся вместе. Если один падает, другой может расти.

### 4. Знай свой риск
Используй VaR и Maximum Drawdown, чтобы понимать, сколько можешь потерять.

### 5. Простота часто лучше
Risk Parity — простой метод, который часто работает лучше сложных стратегий.

---

## Домашнее задание (для любознательных)

1. **Корзины с яйцами**: У тебя 12 яиц и 3 корзины. Придумай, как их распределить, учитывая, что:
   - Корзина 1 падает в 10% случаев
   - Корзина 2 падает в 20% случаев
   - Корзина 3 падает в 30% случаев
   - Корзины падают независимо друг от друга

2. **Мороженое и горячий шоколад**: Как бы ты распределил деньги между этими бизнесами, учитывая, что:
   - Мороженое продаётся летом
   - Горячий шоколад продаётся зимой
   - Какая между ними корреляция?

3. **Запусти код**: Попробуй запустить примеры на Rust и поменяй числа. Что произойдёт, если увеличить корреляцию? Если уменьшить?

---

## Полезные ресурсы

- **Для начинающих**: Книга "Богатый папа, бедный папа" — простое объяснение инвестиций
- **Игры**: Попробуй симулятор фондового рынка, чтобы понять на практике
- **Видео**: На YouTube много простых объяснений диверсификации

---

## Итог

Портфельная оптимизация — это не ракетостроение! Главные идеи простые:

1. **Не клади все яйца в одну корзину**
2. **Выбирай разные активы** (которые не падают одновременно)
3. **Следи за риском** (не только за доходностью)
4. **Проверяй себя** (используй VaR и Drawdown)

Теперь ты знаешь основы! В полной версии главы — больше математики и сложные алгоритмы, но принципы остаются теми же.

---

*Следующая глава: [04. Машинное обучение — как компьютер учится предсказывать](../04-ml-time-series/README.simple.ru.md)*
